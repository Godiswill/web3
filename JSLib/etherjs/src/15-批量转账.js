/**
 * 钱包批量生成 20 个地址
 * 利用代币空投合约方法批量
 * 给 20 个地址空投 0.0001ETH 和 0.0001WETH
 */

import { ethers } from 'ethers';
import abiAirdrop from './abi/AIRDROP.json' assert { type: 'json' };
import abiWETH from './abi/WETH.json' assert { type: 'json' };
// 注意公共节点可能不更新或失效
// https://chainlist.org/chain/11155111 可以替换最新的可以接口用来测试
const ALCHEMY_SEPOLIA_URL = 'https://eth-sepolia.api.onfinality.io/public';
const provider = new ethers.JsonRpcProvider(ALCHEMY_SEPOLIA_URL);

console.log('\n1. 创建 HD 钱包');
// 通过助记词生成 HD 钱包
const mnemonic =
  'metal cereal clump disagree sight recall catch they fire diagram swallow nurse';
const hdNode = ethers.HDNodeWallet.fromPhrase(mnemonic);
console.log(hdNode);
const wallet = new ethers.Wallet(hdNode.privateKey, provider);
// 1. 创建 HD 钱包
// HDNodeWallet {
//   provider: null,
//   address: '0x3cf9a3265E00cfBda31bcFb90a11a684861d0E37',
//   publicKey: '0x027aa4ae560ca8ba74daeafa9fd1f8f1571a4cd3b8ec7407ef37bb468890082600',
//   fingerprint: '0x8a8e58f6',
//   parentFingerprint: '0x25404ca5',
//   mnemonic: Mnemonic {
//     phrase: 'metal cereal clump disagree sight recall catch they fire diagram swallow nurse',
//     password: '',
//     wordlist: LangEn { locale: 'en' },
//     entropy: '0x8c04b0b11f6c8366c9070457279f6c4b'
//   },
//   chainCode: '0x5108073eb7274dee7d6723fc70eb3ca553cc87c9be876b861f26f79a4d797a88',
//   path: "m/44'/60'/0'/0/0",
//   index: 0,
//   depth: 5
// }

console.log('\n2. 通过HD钱包派生20个钱包');
const numWallet = 20;
const addresses = [];
for (let i = 0; i < numWallet; i++) {
  const hdNodeNew = hdNode.derivePath(i.toString());
  // console.log(hdNodeNew);
  const walletNew = new ethers.Wallet(hdNodeNew.privateKey);
  addresses.push(walletNew.address);
}
console.log(addresses);
const amounts = Array(20).fill(ethers.parseEther('0.0001'));
console.log(`发送数额：${amounts}`);

// 2. 通过HD钱包派生20个钱包
// [
//   '0x0d0c3c8015201C0c53f3Db1d5e8fcfD436b3f971',
//   '0xC9d004609BAdbbb94AD7Acd592B62B32Aaa7067d',
//   '0x40acB63e3145f30185f1682F26D12C9De9B44133',
//   '0x75d052486D2Cd080bF9Bdc59Ce763f65Ee7406A7',
//   '0x02a2E6c1392F602C887E194aB2cB58490e000d16',
//   '0x610723f5d61D8519319FAE727776CfC1D2f95d2d',
//   '0x5299e2888a5825c3D42BB575407E683fC556081b',
//   '0x4b3db368023A38FBCf225eD7eDa7230AF413E4c9',
//   '0x86693D67595FA1ce4Aa607F9E692078FEE7E719f',
//   '0xbf299e6863A2eC962f6220D156B96267f686eFE2',
//   '...',
// ]
// 发送数额：100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000,100000000000000

// const bytecodeAirdrop =
//   '6080604052348015600e575f80fd5b50610c9c8061001c5f395ff3fe60806040526004361061003e575f3560e01c806341ed24a21461004257806377988cf81461006a578063ccb8c1e014610086578063fe53c53c146100c2575b5f80fd5b34801561004d575f80fd5b5061006860048036038101906100639190610665565b6100fe565b005b610084600480360381019061007f919061074b565b610304565b005b348015610091575f80fd5b506100ac60048036038101906100a791906107c9565b6104ed565b6040516100b9919061082c565b60405180910390f35b3480156100cd575f80fd5b506100e860048036038101906100e39190610845565b610539565b6040516100f5919061082c565b60405180910390f35b818190508484905014610146576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161013d906108f0565b60405180910390fd5b5f8590505f61015584846104ed565b9050808273ffffffffffffffffffffffffffffffffffffffff1663dd62ed3e33306040518363ffffffff1660e01b815260040161019392919061091d565b602060405180830381865afa1580156101ae573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906101d2919061096e565b1015610213576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161020a906109e3565b60405180910390fd5b5f5b868690508160ff1610156102fa578273ffffffffffffffffffffffffffffffffffffffff166323b872dd3389898560ff1681811061025657610255610a01565b5b905060200201602081019061026b9190610845565b88888660ff1681811061028157610280610a01565b5b905060200201356040518463ffffffff1660e01b81526004016102a693929190610a2e565b6020604051808303815f875af11580156102c2573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102e69190610a98565b5080806102f290610afc565b915050610215565b5050505050505050565b81819050848490501461034c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610343906108f0565b60405180910390fd5b5f61035783836104ed565b905080341461039b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161039290610b6e565b60405180910390fd5b5f5b858590508110156104e5575f8686838181106103bc576103bb610a01565b5b90506020020160208101906103d19190610bc7565b73ffffffffffffffffffffffffffffffffffffffff168585848181106103fa576103f9610a01565b5b9050602002013560405161040d90610c1f565b5f6040518083038185875af1925050503d805f8114610447576040519150601f19603f3d011682016040523d82523d5f602084013e61044c565b606091505b50509050806104d75784848381811061046857610467610a01565b5b905060200201355f8089898681811061048457610483610a01565b5b90506020020160208101906104999190610bc7565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055505b50808060010191505061039d565b505050505050565b5f805f90505b838390508110156105325783838281811061051157610510610a01565b5b90506020020135826105239190610c33565b915080806001019150506104f3565b5092915050565b5f602052805f5260405f205f915090505481565b5f80fd5b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61057e82610555565b9050919050565b61058e81610574565b8114610598575f80fd5b50565b5f813590506105a981610585565b92915050565b5f80fd5b5f80fd5b5f80fd5b5f8083601f8401126105d0576105cf6105af565b5b8235905067ffffffffffffffff8111156105ed576105ec6105b3565b5b602083019150836020820283011115610609576106086105b7565b5b9250929050565b5f8083601f840112610625576106246105af565b5b8235905067ffffffffffffffff811115610642576106416105b3565b5b60208301915083602082028301111561065e5761065d6105b7565b5b9250929050565b5f805f805f6060868803121561067e5761067d61054d565b5b5f61068b8882890161059b565b955050602086013567ffffffffffffffff8111156106ac576106ab610551565b5b6106b8888289016105bb565b9450945050604086013567ffffffffffffffff8111156106db576106da610551565b5b6106e788828901610610565b92509250509295509295909350565b5f8083601f84011261070b5761070a6105af565b5b8235905067ffffffffffffffff811115610728576107276105b3565b5b602083019150836020820283011115610744576107436105b7565b5b9250929050565b5f805f80604085870312156107635761076261054d565b5b5f85013567ffffffffffffffff8111156107805761077f610551565b5b61078c878288016106f6565b9450945050602085013567ffffffffffffffff8111156107af576107ae610551565b5b6107bb87828801610610565b925092505092959194509250565b5f80602083850312156107df576107de61054d565b5b5f83013567ffffffffffffffff8111156107fc576107fb610551565b5b61080885828601610610565b92509250509250929050565b5f819050919050565b61082681610814565b82525050565b5f60208201905061083f5f83018461081d565b92915050565b5f6020828403121561085a5761085961054d565b5b5f6108678482850161059b565b91505092915050565b5f82825260208201905092915050565b7f4c656e67746873206f662041646472657373657320616e6420416d6f756e74735f8201527f204e4f5420455155414c00000000000000000000000000000000000000000000602082015250565b5f6108da602a83610870565b91506108e582610880565b604082019050919050565b5f6020820190508181035f830152610907816108ce565b9050919050565b61091781610574565b82525050565b5f6040820190506109305f83018561090e565b61093d602083018461090e565b9392505050565b61094d81610814565b8114610957575f80fd5b50565b5f8151905061096881610944565b92915050565b5f602082840312156109835761098261054d565b5b5f6109908482850161095a565b91505092915050565b7f4e65656420417070726f766520455243323020746f6b656e00000000000000005f82015250565b5f6109cd601883610870565b91506109d882610999565b602082019050919050565b5f6020820190508181035f8301526109fa816109c1565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f606082019050610a415f83018661090e565b610a4e602083018561090e565b610a5b604083018461081d565b949350505050565b5f8115159050919050565b610a7781610a63565b8114610a81575f80fd5b50565b5f81519050610a9281610a6e565b92915050565b5f60208284031215610aad57610aac61054d565b5b5f610aba84828501610a84565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f60ff82169050919050565b5f610b0682610af0565b915060ff8203610b1957610b18610ac3565b5b600182019050919050565b7f5472616e7366657220616d6f756e74206572726f7200000000000000000000005f82015250565b5f610b58601583610870565b9150610b6382610b24565b602082019050919050565b5f6020820190508181035f830152610b8581610b4c565b9050919050565b5f610b9682610555565b9050919050565b610ba681610b8c565b8114610bb0575f80fd5b50565b5f81359050610bc181610b9d565b92915050565b5f60208284031215610bdc57610bdb61054d565b5b5f610be984828501610bb3565b91505092915050565b5f81905092915050565b50565b5f610c0a5f83610bf2565b9150610c1582610bfc565b5f82019050919050565b5f610c2982610bff565b9150819050919050565b5f610c3d82610814565b9150610c4883610814565b9250828201905080821115610c6057610c5f610ac3565b5b9291505056fea26469706673582212205d2073a0e80779dc5a8a0d090236d49239ba4a045f70ff02100d154d9bac5dc464736f6c634300081a0033';
// 部署 airdrop 批量转账合约，避免重复浪费 gas
// const factoryWETH = new ethers.ContractFactory(
//   abiAirdrop,
//   bytecodeAirdrop,
//   wallet
// );
// const contractAirdrop = await factoryWETH.deploy();
// console.log(`airdrop 合约地址: ${contractAirdrop.target}`);
// console.log('部署合约的交易详情');
// console.log(contractAirdrop.deploymentTransaction());
// console.log('\n等待合约部署上链');
// await contractAirdrop.waitForDeployment();
// console.log('合约已上链');

// 上面部署的 Airdrop 合约地址（Sepolia 测试网）
const addressAirdrop = '0x15B654D1ffB11f1d3E0B8FBACfA9f82DB0E76206'; // Airdrop Contract
// 声明Airdrop合约
const contractAirdrop = new ethers.Contract(addressAirdrop, abiAirdrop, wallet);

// 06 部署的 WETH 合约地址
const addressWETH = '0xE5E4da5C05624459bdA2083e08b0AFf304c9fC52'; // WETH Contract
// 声明WETH合约
const contractWETH = new ethers.Contract(addressWETH, abiWETH, wallet);

console.log('\n3. 读取一个地址的 ETH 和 WETH 余额');
//读取WETH余额
let balance0WETH = await contractWETH.balanceOf(hdNode.address);
const balanceWETH = await contractWETH.balanceOf(addresses[10]);
console.log(`主地址 WETH 持仓: ${ethers.formatEther(balance0WETH)}`);
console.log(`派生某 WETH 持仓: ${ethers.formatEther(balanceWETH)}\n`);
//读取ETH余额
let balance0ETH = await provider.getBalance(hdNode.address);
const balanceETH = await provider.getBalance(addresses[10]);
console.log(`主地址 ETH 持仓: ${ethers.formatEther(balance0ETH)}`);
console.log(`派生某 ETH 持仓: ${ethers.formatEther(balanceETH)}\n`);
// 3. 读取一个地址的ETH和WETH余额
// 主地址 WETH 持仓: 0.001
// 派生某 WETH 持仓: 0.0

// 主地址 ETH 持仓: 0.07313739484638524
// 派生某 ETH 持仓: 0.0003

console.log('\n4. 调用 multiTransferETH() 函数，给每个钱包转 0.0001 ETH');
// 发起交易
const tx = await contractAirdrop.multiTransferETH(addresses, amounts, {
  value: ethers.parseEther('0.002'),
});
// 等待交易上链
await tx.wait();
// console.log(`交易详情：`)
// console.log(tx)
balance0ETH = await provider.getBalance(hdNode.address);
const balanceETH2 = await provider.getBalance(addresses[10]);
console.log(`发送后主钱包 ETH 持仓: ${ethers.formatEther(balance0ETH)}`);
console.log(`发送后某钱包 ETH 持仓: ${ethers.formatEther(balanceETH2)}\n`);
// 4. 调用 multiTransferETH() 函数，给每个钱包转 0.0001 ETH
// 发送后主钱包 ETH 持仓: 0.070340556386874165
// 发送后某钱包 ETH 持仓: 0.0004

console.log('\n5. 调用 multiTransferToken() 函数，给每个钱包转 0.0001 WETH');
const txDeposit = await contractWETH.deposit({
  value: ethers.parseEther('0.002'),
});
await txDeposit.wait();
// 先approve WETH给Airdrop合约
const txApprove = await contractWETH.approve(
  addressAirdrop,
  ethers.parseEther('0.002')
);
await txApprove.wait();
// 发起交易
const tx2 = await contractAirdrop.multiTransferToken(
  addressWETH,
  addresses,
  amounts
);
// 等待交易上链
await tx2.wait();
// console.log(`交易详情：`)
// console.log(tx2)
// 读取WETH余额
balance0WETH = await contractWETH.balanceOf(hdNode.address);
const balanceWETH2 = await contractWETH.balanceOf(addresses[10]);
console.log(`发送后主钱包 WETH 持仓: ${ethers.formatEther(balance0WETH)}`);
console.log(`发送后某钱包 WETH 持仓: ${ethers.formatEther(balanceWETH2)}\n`);
// 5. 调用 multiTransferToken() 函数，给每个钱包转 0.0001 WETH
// 发送后主钱包 WETH 持仓: 0.001
// 发送后某钱包 WETH 持仓: 0.0001
